version: 2.1

parameters:
  # This parameter is used to trigger the main workflow
    trigger:
        type: boolean
        default: true
  
    requirements:
        type: boolean
        default: false

jobs:
    trigger-workflows:
        docker:
            - image: circleci/python:3.6
        steps:
        - checkout
        - run:
            name: Trigger workflows
            command: chmod +x .circleci/commit_check.sh && .circleci/commit_check.sh

    # build:
    #     parameters:
    #         package_name:
    #             type: string
    #     working_directory: ~/project/packages/<< parameters.package_name >>
    #     docker:
    #         - image: circleci/python:3.6
    #     steps:
    #         - checkout
    #         - run:
    #             name: Check commit
    #             command: |
    #                 echo "Build step run"
    #         - persist_to_workspace:
    #             root: ~/project
    #             paths:
    #                 - packages/<< parameters.package_name >>
    build_img:
        parameters:
            package_name:
                type: string
        working_directory: ~/project/packages/<< parameters.package_name >>
        docker:
            - image: 020046395185.dkr.ecr.us-east-1.amazonaws.com/aws-cli:latest
              aws_auth:
                  aws_access_key_id: $AWS_ACCESS_KEY
                  aws_secret_access_key: $AWS_SECRET_ACCESS_KEY
        steps:
            - checkout
            - setup_remote_docker:
                version: 18.06.0-ce
            - run:
                name: Build and push wing/api-audit
                command: |
                    aws configure set \
                    aws_access_key_id $AWS_ACCESS_KEY
                    aws configure set \
                    aws_secret_access_key $AWS_SECRET_ACCESS_KEY
                    aws configure set region $AWS_DEFAULT_REGION
                    chmod +x .circleci/build_img.sh && .circleci/build_img.sh 
            # - run:
            #     name: Configure git and tag branch
            #     command: |
            #         .circleci/push_git_tag.sh
            - persist_to_workspace:
                root: ~/project
                paths:
                    - packages/<< parameters.package_name >>

                    
workflows:
  version: 2
  ci:
    when: << pipeline.parameters.trigger >>
    jobs:
      - trigger-workflows
  others:
    when: << pipeline.parameters.requirements >>
    jobs:
      - build_img:
            package_name: requirements
            filters:
                branches:
                    only:
                        - master